{% extends "base.html" %}
{% block title %}
  {{ post.title }} | {% if post.location and post.location.is_published %}{{ post.location.name }}{% else %}Планета Земля{% endif %} |
  {{ post.pub_date|date:"d E Y" }}
{% endblock %}

{% block content %}
  <div class="col d-flex justify-content-center">
    <div class="card" style="width: 40rem;">
      <div class="card-body">
        {% if post.image %}
          <img class="border-3 rounded img-fluid img-thumbnail mb-2 mx-auto d-block" 
               src="{{ post.image.url }}" 
               alt="{{ post.title }}">
        {% endif %}
        
        <h5 class="card-title">{{ post.title }}</h5>
        
        <div class="card-subtitle mb-3 text-muted">
          <small>
            {{ post.pub_date|date:"d E Y, H:i" }} | 
            {% if post.location and post.location.is_published %}
              {{ post.location.name }}
            {% else %}
              Планета Земля
            {% endif %}
            <br>
            Автор: <a href="{% url 'blog:profile' post.author.username %}">
              @{{ post.author.username }}
            </a> |
            Категория: 
            {% if post.category.is_published %}
              <a href="{% url 'blog:category_posts' post.category.slug %}">
                {{ post.category.title }}
              </a>
            {% else %}
              <span class="text-danger">{{ post.category.title }} (не опубликована)</span>
            {% endif %}
          </small>
        </div>
        
        <p class="card-text">{{ post.text|linebreaksbr }}</p>

        <!-- Ссылки редактирования/удаления поста - строго между текстом поста и комментариями -->
        {% if user == post.author %}
        <div class="d-flex justify-content-end mb-3">
          <a href="{% url 'blog:edit_post' id=post.id %}" class="btn btn-sm btn-outline-secondary me-2">
            Редактировать
          </a>
          <a href="{% url 'blog:delete_post' id=post.id %}" class="btn btn-sm btn-outline-danger">
            Удалить
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Комментарии -->
  <div class="col d-flex justify-content-center mt-4">
    <div class="card" style="width: 40rem;">
      <div class="card-body" id="comments">
        <h6 class="card-subtitle mb-2 text-muted">Комментарии ({{ comments.count }})</h6>
        {% for comment in comments %}
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <strong>{{ comment.author.username }}</strong>
              {% if user == comment.author or user == post.author %}
                <div>
                  <a href="{% url 'blog:edit_comment' post.id comment.id %}" 
                     class="btn btn-sm btn-outline-secondary me-1">
                    Редактировать
                  </a>
                  <a href="{% url 'blog:delete_comment' post.id comment.id %}" 
                     class="btn btn-sm btn-outline-danger">
                    Удалить
                  </a>
                </div>
              {% endif %}
            </div>
            <small class="text-muted">{{ comment.created_at|date:"d E Y, H:i" }}</small>
            <p>{{ comment.text }}</p>
          </div>
        {% empty %}
          <p>Пока нет комментариев.</p>
        {% endfor %}
        
        {% if user.is_authenticated %}
          <form method="post" action="{% url 'blog:add_comment' post.id %}">
            {% csrf_token %}
            <div class="mb-3">
              <textarea name="text" class="form-control" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-sm btn-primary">Отправить</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}